# OpenRoboBrain 风险管理

## 概述

本文档记录 OpenRoboBrain 项目的已识别风险、缓解措施和跟踪状态。所有风险按严重程度分级，并定期评审。

---

## 风险等级定义

| 等级 | 标识 | 描述 | 响应时间 |
|------|------|------|----------|
| **致命** | 🔴 CRITICAL | 可能导致人身伤害、财产损失或系统完全失控 | 立即处理 |
| **高** | 🟠 HIGH | 严重影响系统安全或核心功能，可能导致数据丢失 | 1周内 |
| **中** | 🟡 MEDIUM | 影响系统性能或稳定性，可降级运行 | 2周内 |
| **低** | 🟢 LOW | 轻微影响，可接受的技术债务 | 下次迭代 |

---

## 风险分类

| 类别 | 代码前缀 | 说明 |
|------|----------|------|
| 安全 | SEC | 命令注入、权限绕过、信息泄露等 |
| 控制 | CTL | 紧急停止、Agent终止、运动控制等 |
| 资源 | RES | 内存泄漏、CPU耗尽、队列溢出等 |
| 可靠性 | REL | 竞态条件、数据丢失、服务中断等 |
| 硬件 | HW | 传感器故障、执行器异常、通信中断等 |
| 集成 | INT | ROS2集成、第三方服务、API兼容等 |

---

## 风险状态

| 状态 | 说明 |
|------|------|
| `OPEN` | 已识别，待处理 |
| `IN_PROGRESS` | 正在修复中 |
| `MITIGATED` | 已实施缓解措施，风险降低 |
| `RESOLVED` | 已完全解决 |
| `ACCEPTED` | 接受风险，暂不处理 |
| `MONITORING` | 需持续监控 |

---

## 当前风险清单

### 🔴 致命风险 (CRITICAL)

#### RISK-SEC-001: Shell命令注入漏洞

| 属性 | 值 |
|------|-----|
| **位置** | `orb/system/tools/builtin/shell.py` |
| **描述** | 简单字符串分割无法防止复杂命令注入，攻击者可使用 `$(command)`、反引号、环境变量等绕过安全检查 |
| **影响** | LLM生成恶意命令 → 机器人执行危险操作 → 物理损坏或安全事故 |
| **状态** | `OPEN` |
| **负责人** | - |
| **缓解方案** | 1. 使用 `shlex.quote()` 处理参数<br>2. 改用 `subprocess` 列表参数模式<br>3. 实现完整的命令解析器 |
| **验证方法** | 单元测试：注入攻击向量测试集 |
| **创建日期** | 2026-02-02 |
| **目标日期** | 部署前必须解决 |

---

#### RISK-SEC-002: 工具策略未在执行层强制实施

| 属性 | 值 |
|------|-----|
| **位置** | `orb/agent/runtime/tool_executor.py` |
| **描述** | `ToolPolicy.check()` 存在但未在 `ToolExecutor.execute()` 中调用，`apply_policy` 参数可被禁用 |
| **影响** | 安全策略形同虚设 → Agent可执行任意工具 → 机器人失控 |
| **状态** | `RESOLVED` ✅ |
| **负责人** | - |
| **缓解方案** | 1. 在 `execute()` 开始处强制调用 `ToolPolicy.check()`<br>2. 移除 `apply_policy` 参数或设为内部参数<br>3. 添加审计日志 |
| **验证方法** | 集成测试：尝试绕过策略执行工具 |
| **创建日期** | 2026-02-02 |
| **解决日期** | 2026-02-02 |
| **解决方案** | 在 `ToolExecutor.execute()` 中添加了策略检查，支持 `policy` 参数和 `enforce_policy` 开关。被拒绝的工具调用返回 `DENIED` 状态。 |

---

#### RISK-CTL-001: Subagent无法强制终止

| 属性 | 值 |
|------|-----|
| **位置** | `orb/agent/subagent/spawn.py` |
| **描述** | `stop_spawn()` 仅更新状态标志为 CANCELLED，不会真正取消正在执行的 asyncio 任务 |
| **影响** | 紧急停止命令无效 → Agent继续执行危险动作 → 可能造成伤害 |
| **状态** | `RESOLVED` ✅ |
| **负责人** | - |
| **缓解方案** | 1. 实现 `asyncio.Task.cancel()` 调用<br>2. 添加任务引用跟踪<br>3. 实现清理回调<br>4. 添加超时强制终止 |
| **验证方法** | 测试：启动长时间任务后立即取消，验证立即停止 |
| **创建日期** | 2026-02-02 |
| **解决日期** | 2026-02-02 |
| **解决方案** | 添加了 `_spawn_tasks` 字典存储任务引用，`stop_spawn()` 现在会调用 `task.cancel()` 真正取消任务。新增 `stop_all()` 方法支持紧急批量取消。 |

---

#### RISK-CTL-002: 紧急停止存在竞态条件

| 属性 | 值 |
|------|-----|
| **位置** | `orb/system/brain_pipeline/brain_cerebellum_bridge.py` |
| **描述** | `emergency_stop()` 执行期间，新命令可能被添加到队列，导致停止不完整 |
| **影响** | 紧急停止期间新动作被执行 → 停止失效 |
| **状态** | `OPEN` |
| **负责人** | - |
| **缓解方案** | 1. 添加全局锁机制<br>2. 实现停止标志原子检查<br>3. 清空所有待处理队列<br>4. 等待所有活动任务完成或超时强制终止 |
| **验证方法** | 并发测试：在高负载下触发紧急停止 |
| **创建日期** | 2026-02-02 |
| **目标日期** | 部署前必须解决 |

---

#### RISK-HW-001: 硬件层和中间件层仅为接口定义

| 属性 | 值 |
|------|-----|
| **位置** | `orb/middleware/`, `orb/hardware/` |
| **描述** | ROS2集成、传感器/执行器驱动均未实现，仅为空接口 |
| **影响** | 无法连接真实机器人硬件，系统无法实际运行 |
| **状态** | `OPEN` |
| **负责人** | - |
| **缓解方案** | 1. 实现ROS2节点包装器<br>2. 实现标准传感器驱动<br>3. 实现标准执行器驱动<br>4. 创建模拟器用于测试 |
| **验证方法** | 集成测试：与ROS2环境连通 |
| **创建日期** | 2026-02-02 |
| **目标日期** | 待评估 |

---

### 🟠 高风险 (HIGH)

#### RISK-RES-001: 消息总线无界队列

| 属性 | 值 |
|------|-----|
| **位置** | `orb/system/brain_pipeline/message_bus.py` |
| **描述** | `_queues` 字典中的队列无大小限制，高负载下可能无限增长 |
| **影响** | 内存耗尽 → 系统崩溃 |
| **状态** | `RESOLVED` ✅ |
| **负责人** | - |
| **缓解方案** | 1. 为队列设置 `maxsize`（建议1000）<br>2. 添加背压机制<br>3. 实现队列监控告警 |
| **验证方法** | 压力测试：高消息吞吐场景 |
| **创建日期** | 2026-02-02 |
| **解决日期** | 2026-02-02 |
| **解决方案** | 队列现在默认 maxsize=1000，可通过 `queue_maxsize` 参数配置。发送到满队列时有超时保护（5秒）。添加了 `get_stats()` 方法监控队列状态。 |

---

#### RISK-REL-001: 请求-响应竞态条件

| 属性 | 值 |
|------|-----|
| **位置** | `orb/system/brain_pipeline/message_bus.py` |
| **描述** | `request()` 方法中，Future创建和消息发送之间存在竞态，响应可能在 `send()` 完成前到达 |
| **影响** | 响应丢失 → 超时 → 任务失败 |
| **状态** | `RESOLVED` ✅ |
| **负责人** | - |
| **缓解方案** | 1. 使用锁确保原子性<br>2. 先注册Future再发送消息<br>3. 添加响应缓冲 |
| **验证方法** | 并发测试：高频请求响应场景 |
| **创建日期** | 2026-02-02 |
| **解决日期** | 2026-02-02 |
| **解决方案** | 添加了 `_pending_lock` 异步锁保护 `_pending_responses` 字典。使用 `PendingRequest` 包装器记录创建时间，支持 TTL 过期清理。添加了定时清理任务防止内存泄漏。 |

---

#### RISK-SEC-003: HTTP工具SSRF漏洞

| 属性 | 值 |
|------|-----|
| **位置** | `orb/system/tools/builtin/http.py` |
| **描述** | 无URL验证，可访问内部服务（localhost、127.0.0.1、169.254.169.254等） |
| **影响** | 信息泄露、权限提升、内部服务攻击 |
| **状态** | `OPEN` |
| **负责人** | - |
| **缓解方案** | 1. 实现URL白名单/黑名单<br>2. 阻止内网IP访问<br>3. 阻止云元数据端点 |
| **验证方法** | 单元测试：SSRF攻击向量测试集 |
| **创建日期** | 2026-02-02 |
| **目标日期** | 1周内 |

---

#### RISK-SEC-004: 文件操作路径遍历

| 属性 | 值 |
|------|-----|
| **位置** | `orb/system/tools/builtin/file.py` |
| **描述** | 无 `../` 路径检查，递归删除功能可删除整个目录 |
| **影响** | 读取/删除任意文件 → 系统破坏 |
| **状态** | `OPEN` |
| **负责人** | - |
| **缓解方案** | 1. 规范化路径并检查是否在允许范围内<br>2. 限制根目录访问<br>3. 禁用递归删除或添加确认 |
| **验证方法** | 单元测试：路径遍历攻击测试集 |
| **创建日期** | 2026-02-02 |
| **目标日期** | 1周内 |

---

#### RISK-RES-002: 无资源配额和看门狗

| 属性 | 值 |
|------|-----|
| **位置** | 系统级 |
| **描述** | 无per-Agent CPU/内存限制，无看门狗检测挂起Agent |
| **影响** | 单个Agent耗尽资源 → 系统不可用 |
| **状态** | `OPEN` |
| **负责人** | - |
| **缓解方案** | 1. 实现资源配额管理<br>2. 添加看门狗进程<br>3. 实现心跳超时强制终止 |
| **验证方法** | 压力测试：资源耗尽场景 |
| **创建日期** | 2026-02-02 |
| **目标日期** | 2周内 |

---

### 🟡 中等风险 (MEDIUM)

#### RISK-REL-002: TaskPipeline总线创建竞态

| 属性 | 值 |
|------|-----|
| **位置** | `orb/system/brain_pipeline/task_pipeline.py` |
| **描述** | 检查-创建操作非原子，同一task_id可能创建重复总线 |
| **影响** | 消息路由混乱 |
| **状态** | `OPEN` |
| **缓解方案** | 使用锁或 `setdefault()` 确保原子性 |
| **创建日期** | 2026-02-02 |

---

#### RISK-REL-003: WebSocket待处理请求泄漏

| 属性 | 值 |
|------|-----|
| **位置** | `orb/system/brain_pipeline/websocket_server.py` |
| **描述** | 超时的请求不会从 `_pending_requests` 中清理 |
| **影响** | 内存增长 |
| **状态** | `OPEN` |
| **缓解方案** | 实现TTL清理机制 |
| **创建日期** | 2026-02-02 |

---

#### RISK-REL-004: Subagent默认无超时

| 属性 | 值 |
|------|-----|
| **位置** | `orb/agent/subagent/spawn.py` |
| **描述** | `run_timeout_seconds=0` 表示无超时限制 |
| **影响** | Agent可无限运行 |
| **状态** | `OPEN` |
| **缓解方案** | 设置合理的默认超时（建议300秒） |
| **创建日期** | 2026-02-02 |

---

#### RISK-REL-005: 审计日志仅内存存储

| 属性 | 值 |
|------|-----|
| **位置** | `orb/agent/security/permission.py` |
| **描述** | 审计日志限制10000条，仅存内存，崩溃丢失 |
| **影响** | 无法取证、无法追溯安全事件 |
| **状态** | `OPEN` |
| **缓解方案** | 持久化到SQLite/文件，实现日志轮转 |
| **创建日期** | 2026-02-02 |

---

#### RISK-REL-006: Agent循环无限迭代风险

| 属性 | 值 |
|------|-----|
| **位置** | `orb/agent/runtime/agent_loop.py` |
| **描述** | 默认 `max_iterations=50`，如设置过高可能长时间占用资源 |
| **影响** | 资源耗尽 |
| **状态** | `OPEN` |
| **缓解方案** | 1. 降低默认值（建议20）<br>2. 添加迭代时间限制 |
| **创建日期** | 2026-02-02 |

---

#### RISK-REL-007: 数据持久化缺失

| 属性 | 值 |
|------|-----|
| **位置** | 系统级 |
| **描述** | 大部分状态存储在内存中，重启后丢失 |
| **影响** | 学习经验丢失、系统崩溃后无法恢复 |
| **状态** | `OPEN` |
| **缓解方案** | 实现SQLite/Redis持久化 |
| **创建日期** | 2026-02-02 |

---

### 🟢 低风险 (LOW)

#### RISK-REL-008: LLM响应无大小限制

| 属性 | 值 |
|------|-----|
| **位置** | `orb/system/llm/providers/openai.py` |
| **描述** | JSON解析无大小限制 |
| **影响** | 极端情况下可能OOM |
| **状态** | `ACCEPTED` |
| **创建日期** | 2026-02-02 |

---

## 风险评审记录

| 日期 | 参与者 | 内容 | 结论 |
|------|--------|------|------|
| 2026-02-02 | 系统分析 | 初始风险识别 | 识别5个致命、5个高、7个中、1个低风险 |
| 2026-02-02 | 框架修复 | 核心框架问题修复 | 解决4个框架级风险：工具策略执行、消息总线可靠性、Subagent终止 |

---

## 风险统计

| 等级 | 数量 | OPEN | IN_PROGRESS | RESOLVED |
|------|------|------|-------------|----------|
| 🔴 CRITICAL | 5 | 3 | 0 | 2 |
| 🟠 HIGH | 5 | 3 | 0 | 2 |
| 🟡 MEDIUM | 7 | 7 | 0 | 0 |
| 🟢 LOW | 1 | 0 | 0 | 0 (1 ACCEPTED) |
| **总计** | **18** | **13** | **0** | **4** |

---

## 附录：风险模板

使用以下模板添加新风险：

```markdown
#### RISK-{类别}-{序号}: {简短描述}

| 属性 | 值 |
|------|-----|
| **位置** | `文件路径` |
| **描述** | 详细描述风险 |
| **影响** | 描述潜在影响 |
| **状态** | `OPEN` |
| **负责人** | - |
| **缓解方案** | 缓解措施列表 |
| **验证方法** | 如何验证已修复 |
| **创建日期** | YYYY-MM-DD |
| **目标日期** | YYYY-MM-DD 或 "待评估" |
```

---

## MuJoCo G1 仿真风险 (feature/mujoco-g1-sim)

| ID | 风险 | 影响 | 状态 | 缓解方案 |
|----|------|------|------|---------|
| RISK-SIM-001 | G1 23DOF XML 缺少 damping/armature/frictionloss | 初始化时腿部偏移 | 已规避 | 在 XML `<compiler>` 后加 `<default><joint damping="0.1" armature="0.01" frictionloss="0.1"/></default>` (参考 unitree_rl_gym#47) |
| RISK-SIM-002 | MuJoCo 3.2.6 Windows DLL 初始化失败 | MuJoCo 无法启动 | 已规避 | 固定 `mujoco>=3.1.6` |
| RISK-SIM-003 | 直接加载训练 checkpoint 报 PytorchStreamReader 错误 | 策略无法加载 | 已规避 | 使用 `deploy/pre_train/g1/motion.pt` (已导出策略), 不用训练 checkpoint (参考 unitree_rl_gym#21) |
| RISK-SIM-004 | 预训练策略冻结手臂 | 无法展示抓取动作 | 已知限制 | 手臂控制作为后续迭代 |

---

## 相关文档

- [BUGS.md](./BUGS.md) - BUG跟踪
- [TODO.md](./TODO.md) - 待办任务
- [ARCHITECTURE.md](./ARCHITECTURE.md) - 架构文档
